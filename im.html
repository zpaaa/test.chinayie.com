<!doctype html>
<html lang="zh-CN">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0" />
    <title>国烨惠聊</title>
    <!--<link rel="stylesheet" href="styles/main.css">-->
    <link rel="stylesheet" href="static/styles/gyim.css?v=1">
    <link rel="stylesheet" href="static/styles/index.css?v=1">
</head>

<body>
    <div id='app'>
        <div id='gyim-container' class='wrap clearfix' v-cloak>
            <div class="left fl" id="">
                <div class="search-box">
                    <div class="search-in" :style="{width:isNotSearch?'208px':'198px'}">
                        <input type="text" name="serarch" id="serarch" value="" placeholder="搜索公司名/姓名/手机号" v-model="searchVal"></input>
                        <span class="search-icon"></span>
                    </div>
                    <div class="add-user">
                        <div v-if="isNotSearch" title="创建群组" onclick="showShadow('.group-bg')">+</div>
                        <div v-else style="font-size:14px;width:40px" @click="cancleSearch">取消</div>
                    </div>

                    <div v-if="companyTypeId === 5&&isNotSearch" class="myIcon newmyIcon">
                        <img title="生成撮合订单" onclick="goMkOrder()" src="static/images/mkOrder1.svg" alt=""/>
                    </div>
                </div>
                <div class="conversations" :class="{setChatHeight:companyTypeId === 5&&list.length>0&&!searchVal&&searchVal!==0}">
                    <ul v-if="list.length>0&&!searchVal&&searchVal!==0" class="conversations-ul">
                        <li :data-id="item.phone" v-for='(item,index) in list'
                            v-bind:class="{active:index == currentActiveConver,redpoint:item.red}"
                            v-on:click="addClass(index,item)" ondblclick="showGroup()">
                            <img :src="setPrifile(item.chatType,item.profile)" />
                            <div class="conver_c">
                                <p class="conver_compname" :title="item.sgName">{{item.partnerUserType==9?item.partnerUsername:item.sgName}}</p>
                                <p class="conver_lastmsg">{{lastMsg(item)}}</p>
                            </div>
                            <p v-if="history.partnerUserType!=9" class="conver_time">{{item.partnerUsername}}</p>
                            <p class="conver_time">{{formatDate(item.latestChatTime)}}</p>
                        </li>
                    </ul>
                    <ul v-else class="conversations-ul">
                        <li :data-id="item.phone" v-for='(item,index) in searchList'
                            v-on:click="selectSearch(item)">
                            <img :src="setPrifile(2,item.profile)" />
                            <div class="conver_c">
                                <p class="conver_compname" :title="item.sgName">{{item.sgName}}</p>
                                <p class="conver_lastmsg">{{item.partnerUsername}}</p>
                            </div>
                            <!-- <p class="conver_time">{{formatDate(item.latestChatTime)}}</p> -->
                        </li>
                    </ul>
                </div>
            </div>
            <div class="center fl" id="content">
                <div class="c_top  clearfix">
                    <p class="fl"><img src="static/images/logo2.png" alt=""/><span>国烨惠聊</span></p>
                    <p v-if="history&&history.partnerUserType!==9" class="fr">正在与
                        <span id="curcomp">
                            {{history.sgName}}{{history.partnerUsername?'-'+history.partnerUsername:''}}
                        </span>
                        聊天
                    </p>
                </div>
                <div class="c_center">
                    <div v-if="history" class="chat_win">
                        <div v-for="hisitem in history.chatRecords" class="chat_item">
                            <div class="chatitem_cent" v-if="history.usrUserId === hisitem.usrUserId && !hisitem.content.includes('a1.easemob.com')">
                                <img :src="setPrifile(history.chatType,LOGUSER_HEAD)" class='headimg' />
                                <p :class="{setCursor:hisitem.receiptType === 1?true:false}">
                                    <span class="msg-date"
                                        v-if="hisitem.sendTime">{{formatDate(hisitem.sendTime,1)}}</span>
                                    <span @click="isSetOffersData(hisitem)" v-html="hisitem.content"></span>
                                </p>
                            </div>
                            <div class="chatitem_res" v-if="history.usrUserId !== hisitem.usrUserId && !hisitem.content.includes('a1.easemob.com')">
                                <img :src="setPrifile(history.chatType,history.profile)" class='headimg' />
                                <p :class="{setCursor:hisitem.receiptType === 1?true:false}">
                                    <span class="msg-date"
                                        v-if="hisitem.sendTime">{{formatDate(hisitem.sendTime,1)}}</span>
                                    <span @click="isSetOffersData(hisitem)" v-html="hisitem.content"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="c_bottom">
                    <div class="inpbox clearfix">
                        <textarea rows="" cols="" name="entry" id="entry" placeholder="在此输入" class="fl" style="resize:none;padding-top: 4px;"></textarea>
                        <div class="fr sentBox">
                            <span class="sent-tips">Enter发送，Ctrl+Enter换行</span>
                            <span id="sent">发送</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right fr" v-if="productId || offer_id < 0">
                <!-- 产品信息 -->
                <p class="p_top">
                    当前咨询产品信息
                </p>
                <div class="or_cur">
                    <!--                    <p>-->
                    <!--                        <span class="p_title">产品名称</span>-->
                    <!--                    </p>-->
                    <!--                    <ul class="p_ul">-->
                    <!--                        <li>-->
                    <!--                            <span class="ul_l">发布公司：</span><span class="ul_r">{{history.sgName}}</span>-->
                    <!--                        </li>-->
                    <!--                        <li>-->
                    <!--                            <span class="ul_l">价格：</span><span class="ul_r" style="color: #e0370f;">面议</span>-->
                    <!--                        </li>-->

                    <!--                        <li style="margin-top:20px;">-->
                    <!--                            <div class="orderBox clearfix">-->
                    <!--                                <div class="fl" v-on:click="checkcenter()">-->
                    <!--                                    <p>订单中心</p>-->
                    <!--                                </div>-->
                    <!--                            </div>-->
                    <!--                        </li>-->
                    <!--                    </ul>-->
                    <div class="emptybox">
                        <p></p>
                        <ul class="p_ul">
                            <li style="margin-top:20px;">
                                <div class="orderBox clearfix">
                                    <div class="fl" style="float: none; margin: 0 auto;" v-on:click="checkcenter()">
                                        <p>订单中心</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="or_his">
                    <p class="or_his_tit">与对方的历史订单</p>
                    <div class="or_his_item">
                        <div v-if="historyOrderList.length>0">
                            <ul  @click="goHistoryOrder(list.orderId,list.orderType,list.buyerCompanyId)" v-for="(list, index) in historyOrderList" :key="index">
                                <li>订单号：{{list.orderSn}}</li>
                                <li>品名：{{list.skuName}}</li>
                                <li>数量：{{list.quantity + '吨'}}</li>
                            </ul>
                        </div>
                        <div style="padding:76px 0px;"  class="emptybox" v-else>
                            <p>暂无订单信息</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right fr" id="orders" v-else>
                <!-- 资源单信息 -->
                <p v-if="showMovement||history&&history.latestLookOfferModel==null||!history.latestLookOfferModel.type||history.latestLookOfferModel.type===1" class="p_top">
                    {{showMovement||history.partnerUserType===9?'报盘信息':'当前咨询资源信息'}}
                </p>
                <div class="or_cur"
                    v-if="showMovement||history&&history.latestLookOfferModel==null||!history.latestLookOfferModel.type||history.latestLookOfferModel.type===1">
                    <p  v-if="offer_id">
                        <span class="p_title">{{offers.skuName}}</span>
                         <span class="p_title"
                            v-if="offers.offerStatus!==0||chatReceiptValid ===0">(已失效)
                        </span>
                        <span class="set-color" v-if="showMovement">
                            发布时间：{{format(offers.createdDate,'-')}}</span>
                        <span v-if="showMovement" class="supply"><img :src="offers.offerType===1?'static/images/seller.svg':'static/images/buy.svg'" alt=""></span>
                    </p>
                    <ul class="p_ul" v-if="offer_id">
                        <li>
                            <span class="ul_l">发布公司：</span><span class="ul_r">{{offers.sellerCompanyName}}</span>
                        </li>
                        <li v-if="offers.offerStatus===0&&offers.skuPrice!==0">
                            <span class="ul_l">价格：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.intCurrencyMark}}{{offers.skuPrice}}{{offers.skuPriceFlag === 1 ? "(可议价)" : ''}}</span>
                        </li>
                        <li v-else>
                            <span class="ul_l">价格：</span><span class="ul_r" style="color: #e0370f;">面议</span>
                        </li>
                        <li>
                            <span class="ul_l">交割库：</span><span class="ul_r">{{offers.deliveryWarehouseName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">交割库地址：</span><span class="ul_r">{{offers.deliveryDetailedAddress}}</span>
                        </li>
                        <li>
                            <span class="ul_l">交割时间：</span>
                            <span class="ul_r"
                                v-if="offers.deliveryDateFlag === 2">{{offers.deliveryBeginDate}}之前</span>
                            <span class="ul_r"
                                v-else-if="offers.deliveryDateFlag === 3">{{offers.deliveryDateText}}</span>
                            <span class="ul_r" v-else>{{offers.deliveryBeginDate}} 至 {{offers.deliveryEndDate}}</span>
                        </li>
                        <li>
                            <span class="ul_l">{{showMovement?'可供量：':'重量：'}}</span><span class="ul_r">{{offers.skuQuantity+ offers.infUnitOfMeasureDisplayName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">保证金：</span><span class="ul_r">{{offers.depositRatio}}%</span>
                        </li>
                        <li>
                            <span class="ul_l">货源：</span><span class="ul_r">{{offers.skuOrigin}}</span>
                        </li>
                        <li>
                            <span class="ul_l">交货方式：</span>
                            <span class="ul_r" v-if="offers.deliveryType === 0">买家自提、卖家代运</span>
                            <span class="ul_r" v-if="offers.deliveryType === 1">买家自提</span>
                            <span class="ul_r" v-if="offers.deliveryType === 2">卖家代运</span>
                        </li>
                        <li>
                            <span class="ul_l">发票：</span>
                            <span class="ul_r" v-if="offers.provideInvoiceType === 0">交割当月发票</span>
                            <span class="ul_r" v-if="offers.provideInvoiceType === 1">交割次月发票</span>
                        </li>
                        <li v-if="!showMovement&&companyTypeId !== 5" style="margin-top:20px;">
                            <div v-if="offers.offerStatus===0" class="orderBox clearfix">
                                <p v-if="!ismyoffer && order_id" class="fl">卖家已向你发起订单</p>
                                <div id="sponsor_odr" class="fr" v-if="ismyoffer" v-on:click="sponsor()">
                                    <p>发起订单</p>
                                </div>
                                <div class="fr" v-if="!ismyoffer && order_id" v-on:click="check()">
                                    <p>查看订单</p>
                                </div>
                                <div id="odr_cen" class="fl" v-if="!ismyoffer" v-on:click="checkcenter()">
                                    <p>订单中心</p>
                                </div>
                            </div>
                        </li>
                        <li v-if="offers.offerStatus!==0||chatReceiptValid ===0" style="margin-top:20px;">
                            <div class="orderBox clearfix">
                                <div class="fl" v-on:click="checkcenter()">
                                    <p>订单中心</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="emptybox" v-if="!offer_id">
                        <p>暂无资源单信息</p>
                        <ul class="p_ul">
                            <li style="margin-top:20px;">
                                <div class="orderBox clearfix">
                                    <div class="fl" style="float: none; margin: 0 auto;" v-on:click="checkcenter()">
                                        <p>订单中心</p>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 撮合信息 -->
                <p class="p_top"  v-if="history&&history.latestLookOfferModel&&history.latestLookOfferModel.type===2&&!showMovement">上一个撮合订单信息</p>
                <div class="or_cur" v-if="history&&history.latestLookOfferModel&&history.latestLookOfferModel.type===2&&!showMovement">
                    <!-- <p class="p_title" v-if="offer_id">{{offers.skuName}} <span v-if="offers.offerStatus!=0">(已失效)</span></p> -->
                    <p class="p_title cuohe" v-if="offer_id">
                        {{offers.skuName}}
                        <span v-if="offers.dmkOrderStatus===0">待确认</span>
                        <span v-if="offers.dmkOrderStatus===1">已确认</span>
                        <span v-if="offers.dmkOrderStatus===2">已驳回</span>
                        <span v-if="offers.dmkOrderStatus===3">已确认</span>

                    </p>

                    <ul class="p_ul" v-if="offer_id">
                        <li>
                            <span class="ul_l">订单号：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.dmkOrderSn}}</span>
                        </li>
                        <li>
                            <span class="ul_l">买方公司：</span><span class="ul_r">{{offers.buyerCompanyName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">卖方公司：</span><span class="ul_r">{{offers.sellerCompanyName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">产品：</span><span class="ul_r">{{offers.skuName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">重量：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.dmkOrderQuantity+ offers.infUnitOfMeasureDisplayName}}</span>
                        </li>
                        <li>
                            <span class="ul_l">价格：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.dmkOrderPrice+ "元/" + offers.infUnitOfMeasureDisplayName}}</span>
                        </li>

                        <li>
                            <span class="ul_l">交割库：</span><span class="ul_r">{{offers.deliveryWarehouseName}}</span>
                        </li>

                        <li>
                            <span class="ul_l">免仓期：</span><span class="ul_r">{{offers.warehouseFreeDays+ "天"}}</span>
                        </li>
                        <li>
                            <span class="ul_l">付款方式：</span>
                            <span class="ul_r" v-if="offers.paymentType === 0">全部支持</span>
                            <span class="ul_r" v-if="offers.paymentType === 1">先货后款</span>
                            <span class="ul_r" v-if="offers.paymentType === 2">先款后货</span>
                        </li>
                        <li>
                            <span class="ul_l">保证金：</span><span class="ul_r">{{offers.depositRatio+ "%"}}</span>
                        </li>
                        <li>
                            <span class="ul_l">货源：</span><span class="ul_r">{{offers.skuOrigin}}</span>
                        </li>
                        <li>
                            <span class="ul_l">买方撮合费：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.dmkBuyerPayAmount + "元/吨"}}</span>
                        </li>
                        <li>
                            <span class="ul_l">卖方撮合费：</span><span class="ul_r"
                                style="color: #e0370f;">{{offers.dmkSellerPayAmount+ "元/吨"}}</span>
                        </li>

                        <li>
                            <div class="orderBox clearfix">
                                <div class="fr" v-on:click="goMkOrderList(offers.id)">
                                    <p>查看订单</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="emptybox" v-if="!offer_id">
                        <p>暂无撮合信息</p>
                    </div>
                </div>

                <div class="or_his">
                    <p class="or_his_tit">与对方的历史订单</p>
                    <div class="or_his_item">
                        <div v-if="historyOrderList.length>0">
                            <ul  @click="goHistoryOrder(list.orderId,list.orderType,list.buyerCompanyId)" v-for="(list, index) in historyOrderList" :key="index">
                                <li>订单号：{{list.orderSn}}</li>
                                <li>品名：{{list.skuName}}</li>
                                <li>数量：{{list.quantity + '吨'}}</li>
                            </ul>
                        </div>
                        <div style="padding:76px 0px;"  class="emptybox" v-else>
                            <p>暂无订单信息</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- </div> -->
            <!-- 创建分组搜索 -->
            <div class="group-bg">
                <div class="group-con">
                    <div class="group-title">
                        <span>创建分组</span>
                        <span onclick="closeShadow('.group-bg')">×</span>
                        <span class="error">{{errorWord}}</span>
                    </div>
                    <div class="group-content">
                        <div class="group-content-l">
                            <div class="group-search">
                                <input @keyup="searchCompany" v-model="searchWords" type="search"
                                    placeholder="搜索公司名/姓名/手机号">
                                <span @click="searchCompany($event,1)" class="search-icon"></span>
                            </div>
                            <div class="search-list">
                                <div  v-if="item.users.length>0"  class="search-list-item" v-for="(item,index) in searchUserList">
                                    <div  @click="selectUesrIndex = index">
                                        <img :src="setPrifile(2,item.companyLogo)" alt="">
                                        <span class="search-list-name">{{item.companyName}}</span>
                                        <span>({{item.users.length}}人)</span>
                                        <span><img class="xiala" :style='{transform:selectUesrIndex === index? "rotate(180deg)":"rotate(0deg)" }' src="static/images/xiala_icon.png" alt=""> </span>
                                    </div>
                                    <div @click="selectUser(index,subIndex)"
                                         :style='{display:selectUesrIndex === index? "block":"none" }'
                                         class="sub-item"
                                         v-for="(subItem, subIndex) in item.users">
                                         <span class="sub-item-log"></span>
                                         <span>{{subItem.username + '&nbsp&nbsp&nbsp  ' + subItem.phone}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="group-content-r">
                            <div class="group-cont">{{'已选择公司联系人：'+selectedList.length +'/100'}}</div>
                            <div class="search-list select-list">
                                <div class="search-list-item" v-for="(item,index) in selectedList"
                                    @click="deleteSelected(index)">
                                    <img :src="setPrifile(2,item.companyLogo)" alt="">
                                    <span class="search-list-name">{{item.companyName}}</span>
                                    <span class="search-list-username" style="margin-left:15px;">{{item.username}}</span>
                                    <!-- <span class="delete-member"><img src="static/images/delete.svg" alt=""></span> -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="group-foot">
                        <div class="group-button">
                            <div onclick="createGroupName()">确定</div>
                            <div onclick="closeShadow('.group-bg')">取消</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 创建分组名称 -->
            <div class="group-name-bg">
                <div class="group-name-con">
                    <div class="group-title">
                        <span>创建分组</span>
                        <span onclick="closeShadow('.group-name-bg')">×</span>
                        <span class="error">{{errorWord}}</span>
                    </div>
                    <div class="group-name-form">
                        <span>分组名称</span>
                        <input v-model.trim="groupName" type="text" placeholder="请输入分组名称">
                    </div>
                    <div class="group-foot">
                        <div class="group-button">
                            <div onclick="createGroup()">确定</div>
                            <div onclick="closeShadow('.group-name-bg')">取消</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 显示群组员 -->
            <div class="showGroup">
                <div class="showGroup-con">
                    <div class="group-title">
                        <span>{{history.sgName}}</span>
                        <span onclick="closeShadow('.showGroup')">×</span>
                    </div>
                    <div class="showGroup-list">
                        <div class="search-list-item" v-for="(item,index) in history.groupMembers">
                            <img :src="setPrifile(2,item.profile)" alt="">
                            <span>{{item.companyName}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script src="static/scripts/jquery.js"></script>
        <!-- <script src="static/scripts/test.js"></script>  -->
        <script src="static/assets/sdk/webim.config.js"></script>
        <script src="static/assets/sdk/strophe-1.2.8.js"></script>
        <script src='static/assets/sdk/websdk-1.4.13.js'></script>
        <script src='static/scripts/gyim.js'></script>
        <script src="static/scripts/vue.min.js"></script>
        <script src="static/scripts/socket.io-1.2.0.js"></script>
        <script>
            var userInfo = JSON.parse(localStorage.getItem("userInfo"));
            var chatwindow = document.getElementsByClassName("chat_win")[0];
            var inpele = document.getElementById("entry");
            var conversationsUl = document.getElementsByClassName("conversations-ul")[0];
            var touserobj = {}; // 当前用户目标
            var vueIM = new Vue({
                el: '#app',
                data: {
                    currentActiveConver: 0,
                    chatContentList: [], // 会话列表
                    history: [],
                    searchVal: '', //默认输入为空
                    letter: '', //默认不排序
                    original: false, //默认从小到大排列
                    offers: {},
                    order_id: 0,
                    offer_id: 0,
                    productId: URL_PRODUCTID,
                    ismyoffer: false,
                    historyOrderList: [],
                    selectedList: [],
                    searchUserList: [],
                    searchWords: '',
                    groupName: '',
                    errorWord: '',
                    changeGroup: false,
                    selectUesrIndex: '',
                    searchChatlist:[],
                    searchList: [],
                    list: [],
                    companyTypeId: JSON.parse(localStorage.getItem("userInfo")).companyTypeId || 0,
                    showMovement: false,
                    chatReceiptValid: 1,
                    addRobotTips: true
                },
                created: function () {
                    // 获取用户名，用户头像，公司头像，历史聊天记录
                        var that = this;
                        LOGUSER_HEAD = userInfo.companyLogo;
                        user_companyid = userInfo.companyId;
                        if (!URL_TOSER || URL_TOSER == 1 || !touserCompanyId) {
                            return;
                        }
                        $.ajax({
                            type: "post",
                            url: newHistoryOrder,
                            data: JSON.stringify({
                                "pageNum": 1,
                                "pageSize": 3,
                                "data": {
                                    "sellerCompanyId": touserCompanyId,
                                    "buyerCompanyId": user_companyid
                                }
                            }),
                            xhrFields: {
                                withCredentials: true
                            },
                            contentType: 'application/json',
                            async: true,
                            success: function (order) {
                                that.historyOrderList =
                                    order.data.list;
                            }
                        });

                        if (URL_OFFERS || URL_PRODUCTID) {
                            $.ajax({
                                type: "post",
                                url: SAVE_OFFER_ID,
                                data: JSON.stringify({
                                    "sellerCompanyId": touserCompanyId,
                                    "buyerCompanyId": user_companyid,
                                    "offerId": URL_OFFERS ? URL_OFFERS : URL_PRODUCTID,
                                    "type": 1
                                }),
                                xhrFields: {
                                    withCredentials: true
                                },
                                contentType: 'application/json',
                                async: false,
                                success: function (data) {

                                }
                            })
                        }
                },
                methods: {
                    // 取的什么鬼名字，根本就不是添加类的方法，切换当前会话的时候用的来获取聊天记录的
                    addClass: function (index, item) {
                        var that = this;
                        this.showMovement = false;
                        if (item.partnerUserType == 9) {
                            this.showMovement = true;
                        }
                        this.chatReceiptValid = 1;

                        this.currentActiveConver = index;
                        item.red = false;
                        if (item.latestLookOfferModel) {
                            this.offer_id = item.latestLookOfferModel.offerId;
                            this.order_id = item.last_orderid;
                        } else {
                            this.offer_id = 0
                        }

                        touserCompanyId = item.partnerCompanyId;
                        if (item.sgId != 1 && item.chatType != 1&& touserCompanyId && user_companyid) {
                            $.ajax({
                                type: "post",
                                url: newHistoryOrder,
                                data: JSON.stringify({
                                    "pageNum": 1,
                                    "pageSize": 3,
                                    "data": {
                                        "sellerCompanyId": touserCompanyId,
                                        "buyerCompanyId": user_companyid
                                    }
                                }),
                                xhrFields: {
                                    withCredentials: true
                                },
                                contentType: 'application/json',
                                async: true,
                                success: function (order) {
                                    that.historyOrderList = order.data.list;

                                }
                            });
                        } else {
                            that.historyOrderList = ""
                        }
                        this.render(item);
                        if (item.chatType == 1) {
                            this.offer_id = 0
                        }

                        renderOffer();
                    },
                    isSetOffersData (item) {
                        if(item.receiptType ==1 ) {
                            this.showMovement = true;
                        }
                        if(item.receiptId&&vueIM.history.partnerUserType != 9||item.receiptType!=1) {
                            return;
                        }
                        this.chatReceiptValid = item.receiptValid;
                        this.offer_id = item.receiptId;
                        renderOffer();

                    },
                    // 添加当前会话的聊天记录，顺便滚动一下聊天窗口，保持最后一条消息在最底下
                    push: function (newdata) {
                        this.history.push(newdata);
                        this.$nextTick(function () {
                            $(".c_center").scrollTop($(".c_center")[0].scrollHeight);
                        })
                    },
                    // 添加当前会话的聊天记录，顺便滚动一下聊天窗口，保持最后一条消息在最底下
                    pushSingleWord: function (newdata) {
                        this.history = newdata;
                        this.$nextTick(function () {
                            $(".c_center").scrollTop($(".c_center")[0].scrollHeight);
                        })
                    },
                    // 添加会话列表
                    push_conver: function (newdata) {
                        this.chatContentList.unshift(newdata);
                    },
                    // 和 push 差不多，这个是直接替换聊天窗口的内容
                    render: function (lists) {
                        this.history = lists;
                        this.$nextTick(function () {
                            $(".c_center").scrollTop($(".c_center")[0].scrollHeight);
                        })
                    },
                    // 替换会话列表，给第一个会话添加 active 状态
                    render_contact: function (list) {
                        this.chatContentList = list;
                        this.$nextTick(function () {
                            $(".conversations-ul li:first").addClass("active");
                        });
                    },
                    render_newConList: function (list) {
                        this.chatContentList = list;
                    },
                    setConListOrder: function () {
                        vueIM.chatContentList.unshift(vueIM.chatContentList.splice(vueIM
                            .currentActiveConver, 1)[0]);
                        vueIM.currentActiveConver = 0;

                    },
                    goHistoryOrder: function(id,typeId, buyerCompanyId) {
                        if(typeId == 1&& userInfo.companyId == buyerCompanyId) {
                            window.open('/my.html#/order/detail?orderId=' + id)
                        } else if(typeId == 1 && userInfo.companyId != buyerCompanyId) {
                            window.open('/my.html#/order/salesDetail?orderId=' + id)
                        }else if (typeId == 2) {
                             window.open('/my.html#/marriedDeal/order/detail?id=' + id)
                        }
                    },
                    // 时间格式化 YYYY-M-D
                    format: function (fmt,sign = '/') {
                        var d = new Date(fmt); //根据时间戳生成的时间对象
                        var datestr = (d.getFullYear()) + sign +
                            (d.getMonth() + 1) + sign +
                            (d.getDate());
                        return datestr;
                    },
                    // 新消息提醒的小红点
                    addRed: function (index) {
                        this.chatContentList[index].red = true;
                    },
                    removeRed: function (index) {
                        this.chatContentList[index].red = false;
                    },
                    // 发起订单
                    sponsor: function () {
                        if (!this.offers.id) {
                            alert("无效的资源单")
                        } else {
                            window.open(SPONSOR_ODR + this.offers.id + "&buyCompanyId=" + touserCompanyId); // 1
                        }
                    },
                    // 订单详情
                    check: function () {
                        if (this.order_id) {
                            window.open(CHECK_ODR + this.order_id);
                        }
                    },
                    // 订单列表
                    checkcenter: function () {
                        window.open(ORDER_CENTER);
                    },
                    goMkOrderList(id) {
                        window.location.href = '/my.html#/marriedDeal/order/detail?id=' + id;
                    },
                    // 建组选择联系人
                    selectUser: function (index, subIndex) {
                        var flag = true;
                        var userData = this.searchUserList[index].users[subIndex];
                        userData.companyName = this.searchUserList[index].companyName;
                        userData.companyLogo = this.searchUserList[index].companyLogo;
                        userData.usrCompanyId = this.searchUserList[index].usrCompanyId;

                        for (var i = 0; i < this.selectedList.length; i++) {
                            if (this.selectedList[i].usrUserId == userData.usrUserId
                               &&this.selectedList[i].usrCompanyId == userData.usrCompanyId) {
                                flag = false;
                            }
                        }
                        if (flag) {
                            this.selectedList.push(userData);
                        }
                        this.searchUserList[index].users.splice(subIndex, 1);
                    },
                    // 建组删除联系人
                    deleteSelected: function (index) {
                        var flag = true;
                        var tempIndex;
                        if(this.searchUserList.length>0) {
                            for (var i = 0; i < this.searchUserList.length; i++) {
                                    if (this.searchUserList[i].usrCompanyId == this.selectedList[index].usrCompanyId) {
                                        tempIndex = i;
                                        for (var j= 0; j< this.searchUserList[i].users.length; j++) {
                                            if(this.searchUserList[i].users[j].usrUserId == this.selectedList[index].usrUserId) {
                                                flag = false;
                                            }
                                        }
                                }

                            }
                            if (flag) {
                                this.searchUserList[tempIndex].users.push(this.selectedList[index]);
                            }
                        }

                        this.selectedList.splice(index, 1);
                    },
                    // 搜索联系人
                    searchCompany: function (e, isSearch) {
                        var that = this;
                        var code = e.charCode || e.keyCode;
                        var timer;
                        clearTimeout(timer);
                        timer = setTimeout(function () {
                            if (code == 13 || that.searchWords.length >= 3 || isSearch) {
                                $.ajax({
                                    type: "get",
                                    url: SEARCH_COMP,
                                    async: true,
                                    data: {
                                        usrCompanyId: userInfo.companyId,
                                        keywords: that.searchWords,
                                        usrUserId: userInfo.id
                                    },
                                    success: function (data) {
                                        vueIM.searchUserList = data.data;
                                        // console.log(vueIM.searchUserList);
                                    }
                                })
                            }
                        }, 200)

                    },
                    setPrifile: function (chat, profile) {
                        if (chat == 2) {
                            return profile ? profile : 'static/images/geren.png'
                        } else {
                            return profile ? profile : 'static/images/qunzu.png'
                        }

                    },
                    // 查询更多详情
                    chatListDetails: function (chatType, sgId) {
                        $.ajax({
                            type: "GET",
                            url: CHATLIST_DETAILS + chatType + '/' + sgId,
                            async: true,
                            dataType: "json",
                            contentType: 'application/json',
                            data: {
                                usrUserId: userInfo.id
                            },
                            success: function (datas) {
                                console.log(datas);
                            },
                            error: function (data) {}
                        });
                    },
                    formatDate: function (date, type) {
                        var nowDate = new Date();
                        var time = nowDate.getTime();
                        var oneDay = 24 * 60 * 60 * 1000;
                        var isSameDate = nowDate.getDate() == new Date(date).getDate();
                        var weekday = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
                        var oldTime = new Date(date).Format("hh:mm");
                        if (time - date < oneDay && isSameDate) {
                            return oldTime;
                        } else if ((time - date > oneDay || !isSameDate) && time - date < oneDay * 2) {
                            return type ? '昨天 ' + oldTime : '昨天 ';
                        } else if (time - date > oneDay || time - date < oneDay * 7) {
                            return type ? weekday[new Date(date).getDay()] + ' ' + oldTime : weekday[
                                new Date(date).getDay()];
                        } else if (time - date > oneDay * 7) {
                            return type ? this.format(date) + ' ' + oldTime : this.format(date);
                        }

                    },
                    lastMsg: function (item) {
                        if (!item.chatRecords||item.chatRecords.length == 0) {
                            return ''
                        } else if (item.chatRecords[item.chatRecords.length - 1].content.indexOf(
                                '<img data-isimg="1"') >= 0) {
                            return '【图片】消息'
                        } else {
                            return item.chatRecords[item.chatRecords.length - 1].content
                        }
                    },
                    cancleSearch: function () {
                        this.searchVal = '';
                    },
                    selectSearch: function (data) {
                        var index; var item;
                        var chatType = data.chatType;
                      for (var i=0;i<this.chatContentList.length;i++) {
                          console.log(this.chatContentList[i].sgId, data.sgId)
                          if(chatType==1&& this.chatContentList[i].sgId == data.sgId) {
                               index = i;
                               item = this.chatContentList[i];
                               break;
                           }
                           else if(chatType == 2&&data.partnerCompanyId == this.chatContentList[i].partnerCompanyId &&
                            data.sgId == this.chatContentList[i].sgId) {

                                index = i;
                                item = this.chatContentList[i];
                                break;
                            }
                      }
                    //   var chatData = Object.assign({},data);
                      if(!index&&index!=0) {
                          item = Object.assign({}, data);
                          item.chatRecords = [];
                          item.latestLookOfferModel = {};
                          item.phone = item.phone + '-' + item.partnerCompanyId
                          index = 0;
                          this.chatContentList.unshift(item);
                      }else {
                           vueIM.chatContentList.unshift(vueIM.chatContentList.splice(index, 1)[0]);
                           index= 0;
                      }
                      this.addClass(index, item);
                      this.cancleSearch();
                    }
                },
                // 通过计算属性过滤数据
                computed: {
                    // 被搜索企业名的输入字段过滤后的会话列表
                    // list: function () {
                        // return this.chatContentList.filter(function (item) {
                        //     return item.sgName.search(this.searchVal) != -1;
                        // }, this);
                    // }
                    isNotSearch: function() {
                        return !this.searchVal && this.searchVal !== 0
                    }
                },
                watch: {
                     searchVal: function() {
                          $.ajax({
                            type: "get",
                            url: SEARCH_CONCANTACTS,
                            async: true,
                            data: {
                                usrCompanyId: userInfo.companyId,
                                keywords: this.searchVal,
                                usrUserId: userInfo.id
                          },
                          success: function (data) {
                             vueIM.searchList = data.data.contacts;
                            //  vueIM.$forceUpdate()
                          }
                          })
                        //  this.list = this.chatContentList.filter(function (item) {
                        //          return item.sgName.search(this.searchVal) != -1;
                        // }, this);

                     },
                    errorWord: function () {
                        var timer;
                        clearTimeout(timer);
                        timer = setTimeout(function () {
                            vueIM.errorWord = '';
                        }, 3000)
                    },
                    history: function () {
                        if (vueIM.history && vueIM.history.chatType == 1) {
                            return;
                        }
                        vueIM.ismyoffer = vueIM.history && vueIM.history.latestLookOfferModel&& vueIM.history.latestLookOfferModel.sellerCompanyId == userInfo.companyId
                    },
                    searchUserList: function () {
                        // vueIM.$forceUpdate()
                        //   console.log(vueIM.searchUserList);
                    },
                    chatContentList: function() {
                        vueIM.list = vueIM.chatContentList;
                        console.log(vueIM.list)
                    }

                }

            });
            // 根据号码获取 id 和公司 id，同步操作
            function getId(phone) {
                var ids = {
                    uid: "",
                    cid: ""
                };
                if(!phone) {
                    return ids
                }
                phone = phone.split("-")[0];

                $.ajax({
                    type: "post",
                    url: COMP_API,
                    data: JSON.stringify({
                        mobile: phone,
                        userType: 0
                    }),
                    contentType: 'application/json',
                    xhrFields: {
                        withCredentials: true
                    },
                    async: false,
                    success: function (data) {
                        if (!data.code) {
                            ids.uid = data.data.id;
                            ids.cid = data.data.companyId;
                        };
                        console.log(data);
                    }
                });
                return ids;
            };
            // sent('您好');


            function init() { // 首次加载渲染
                // var firstlist = "static/scripts/api_converlist1.json";
                // 获取本地写好的数据，也是同步的
                $.ajax({
                    type: "get",
                    // url: firstlist,
                    url: SEARCH_CHATLIST,
                    data: {
                        usrUserId: userInfo.id,
                        usrCompanyId: userInfo.companyId
                    },
                    async: false,
                    success: function (data) {
                        if(URL_TOSER == '13800000000') {
                            vueIM.showMovement = true;
                             vueIM.chatReceiptValid = 1;
                        }
                        var conevrList = data.data;
                        vueIM.render_contact(conevrList);
                        if (USER_TYPE == 1 || USER_TYPE == 2 || USER_TYPE == 3) {
                            init_his(URL_TOSER); // 展示历史记录
                            var hashis = false;
                            vueIM.offer_id = URL_OFFERS;

                            if (URL_TOSER && URL_TOSER != 1 && touserCompanyId) {
                                $.ajax({
                                    type: "post",
                                    url: COMP_API,
                                    data: JSON.stringify({
                                        mobile: URL_TOSER,
                                        companyId: touserCompanyId,
                                        userType: URL_TOSER== '13800000000'?9:0
                                    }),
                                    xhrFields: {
                                        withCredentials: true
                                    },
                                    contentType: 'application/json',
                                    async: false,
                                    success: function (data) {
                                        var data_name = data.data.companyName;
                                        var data_head = data.data.profileImg;
                                        var data_myphone = data.data.phone;
                                        touserobj.phone = URL_TOSER + '-' +  touserCompanyId;
                                        touserobj.profile = data_head;
                                        touserobj.sgName = data_name + '-' + data.data.username;
                                        touserobj.sgId = data.data.id;
                                        touserobj.chatType = 2;
                                        touserobj.usrUserId = userInfo.id;
                                        touserobj.partnerCompanyId = data.data.companyId;
                                        touserobj.usrCompanyId = userInfo.companyId;
                                        // touserobj.receiptId =

                                        conevrList.map(function (currentValue, index, arr) {
                                            if(currentValue.partnerUserType == 9) {
                                                var chatData = '您好，我是撮合机器人，负责为您推送您感兴趣商品的买卖盘资料，请勿回复'
                                                   arr[index].chatRecords.push({
                                                     usrUserId: currentValue.partnerCompanyId,
                                                     sgId: currentValue.sgId,
                                                     chatType: currentValue.chatType,
                                                     sendTime: new Date().getTime(),
                                                     content: chatData
                                                 })
                                                 vueIM.addRobotTips = false;
                                            }
                                            if (currentValue.phone == URL_TOSER + '-' + touserobj.partnerCompanyId) {
                                                arr.splice(index, 1);
                                                hashis = true;
                                                touserobj = currentValue;
                                                if (URL_OFFERS) {
                                                    touserobj.latestLookOfferModel.offerId = URL_OFFERS;
                                                    currentValue.latestLookOfferModel.offerId = URL_OFFERS;
                                                }

                                                vueIM.offer_id = touserobj.latestLookOfferModel.offerId;
                                                arr.unshift(currentValue);

                                                return arr
                                            }
                                        });
                                        if (URL_OFFERS) {
                                            if (!hashis) {
                                                touserobj.chatRecords = [ {
                                                    usrUserId: userInfo.id,
                                                    sgId: data.data.id,
                                                    chatType: 2,
                                                    sendTime: new Date().getTime(),
                                                    content: "您好，我想咨询与资源单(id:" + URL_OFFERS + ")有关的信息"
                                                }]
                                            } else {
                                                touserobj.chatRecords.push({
                                                    usrUserId: userInfo.id,
                                                    sgId: data.data.id,
                                                    chatType: 2,
                                                    sendTime: new Date().getTime(),
                                                    content: "您好，我想咨询与资源单(id:" + URL_OFFERS + ")有关的信息"
                                                });
                                            }

                                            // sendWord(touserobj, 1, '您好')
                                            sendWord(touserobj, 2 , "您好，我想咨询与资源单(id:" + URL_OFFERS + ")有关的信息");

                                            touserobj.red = false;
                                            touserobj.latestLookOfferModel = {
                                                "sellerCompanyId": data.data.companyId,
                                                "buyerCompanyId": userInfo.companyId,
                                                "offerId": URL_OFFERS,
                                                "type": 1
                                            };
                                            touserobj.last_orderid = 0;
                                            touserobj.myoffer = false;
                                        }else if(URL_PRODUCTID){
                                            touserobj.chatRecords = [{
                                                usrUserId: userInfo.id,
                                                sgId: data.data.id,
                                                chatType: 2,
                                                sendTime: new Date().getTime(),
                                                content: "您好，我想咨询与产品（id:" + Math.abs(URL_PRODUCTID) + "）有关的信息"
                                            }]
                                            sendWord(touserobj, 2, '您好，我想咨询与产品（id:' + Math.abs(URL_PRODUCTID) + '）有关的信息');
                                        }
                                        else {
                                            if (!hashis) {
                                                touserobj.chatRecords = [{
                                                    usrUserId: userInfo.id,
                                                    sgId: data.data.id,
                                                    chatType: 2,
                                                    sendTime: new Date().getTime(),
                                                    content: '您好'
                                                }]
                                                sendWord(touserobj, 1, '您好')

                                            }
                                        }
                                        if (!hashis) {
                                            conevrList.unshift(touserobj);
                                        }
                                    }

                                });
                            }
                            if (!URL_TOSER || URL_TOSER == 1) {
                                  conevrList.map(function (currentValue, index, arr) {
                                    if (currentValue.partnerUserType == 9) {
                                        var chatData = '您好，我是撮合机器人，负责为您推送您感兴趣商品的买卖盘资料，请勿回复'
                                        arr[index].chatRecords.push({
                                            usrUserId: currentValue.partnerCompanyId,
                                            sgId: currentValue.sgId,
                                            chatType: currentValue.chatType,
                                            sendTime: new Date().getTime(),
                                            content: chatData
                                        })
                                        vueIM.addRobotTips = false;
                                    }
                                });
                                renderFristConver();
                                conevrList.unshift(touserobj);
                            }
                            // localStorage.setItem("coverList_" + LOGUSER, JSON.stringify(conevrList));
                            // 发信息给后台 todoing
                            vueIM.render_contact(conevrList);
                            vueIM.render(conevrList[0]);
                            renderOffer(); //（买家身份）渲染初始的资源单
                        } else if (USER_TYPE == 0) {
                            touserobj = conevrList[0];
                            vueIM.render_contact(conevrList);
                            vueIM.currentActiveConver = 0;
                            init_his(touserobj.phone);
                        }
                    },
                    error: function (data) {
                        console.log(data)
                    }
                });
            };


            function renderFristConver(touser) { //渲染第一条
                if (touser == 1 || !touser) {
                    touserobj.phone = URL_TOSER + '-' + touserobj.partnerCompanyId;
                    touserobj.profile = "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1533103834130&di=61a5730df73a91717c09326166f75cd5&imgtype=0&src=http%3A%2F%2Fimg07.tooopen.com%2Fimages%2F20170706%2Ftooopen_sy_215440799889.jpg";
                    touserobj.sgName = "国烨";
                    touserobj.sgId = 1;
                    touserobj.lastTxt = "欢迎使用国烨聊天系统，这里是示例聊天窗口，看见我，您就可以跟别人聊天了哦，请勿回复";
                    touserobj.chatType = 2;
                    touserobj.red = false;
                    touserobj.latestLookOfferModel = {
                        "sellerCompanyId": '',
                        "buyerCompanyId": '',
                        "offerId": 0
                    }
                    touserobj.last_orderid = 0;
                    touserobj.myoffer = false;
                    touserobj.chatRecords = [{
                        usrUserId: userInfo.id,
                        sgId: 1,
                        chatType: 2,
                        sendTime: new Date().getTime(),
                        content: '您好'
                    }, {
                        usrUserId: userInfo.id,
                        sgId: 1,
                        chatType: 2,
                        sendTime: new Date().getTime(),
                        content: touserobj.lastTxt
                    }];
                } else {
                    $.ajax({
                        type: "post",
                        url: COMP_API,
                        data: JSON.stringify({
                            mobile: touser,
                            companyId: touserCompanyId,
                            userType: touser == '13800000000' ? 9 : 0
                        }),
                        xhrFields: {
                            withCredentials: true
                        },
                        contentType: 'application/json',
                        async: false,
                        success: function (data) {
                            var data_name = data.data.companyName;
                            var data_head = data.data.profileImg;
                            var data_myphone = data.data.phone;
                            touserobj.touser = URL_TOSER;
                            touserobj.touser_head = data_head;
                            touserobj.coname = data_name;
                            touserobj.lastTxt = "您好";
                            touserobj.time = new Date().Format("hh:mm");
                            touserobj.red = false;
                            touserobj.latestLookOfferModel.offerId = URL_OFFERS;
                            touserobj.last_orderid = 0;
                            touserobj.myoffer = false;
                        }
                    });
                }
            };

            function init_his(converuser) {
                // 会话列表中如果有会话记录，渲染资源单数据
                var localhistory;
                vueIM.chatContentList && vueIM.chatContentList.forEach(function (currentValue) {
                    // if (currentValue.touser == converuser) {
                    if (currentValue.phone == converuser) {
                        vueIM.offer_id = currentValue.latestLookOfferModel.offerId;
                        vueIM.render(currentValue);
                    }
                });
            };
            var safetyTime = new Date().getTime();
            gyim.conn.listen({
                onOpened: function (message) { //连接成功回调，连接成功后才可以发送消息
                    safetyTime = new Date().getTime();
                    console.log("%c [opened] 连接已成功建立", "color: green");
                },
                onTextMessage: function (message) {
                    console.log(message);
                    var nowTime = new Date().getTime();
                    if (nowTime - safetyTime < 2500) {
                        return;
                    }
                    var messageobj = {
                        from: message.from,
                        to: LOGUSER,
                        content: message.data,
                        time: new Date().Format("hh:mm"),
                        date: new Date().Format("yyyy/MM/dd hh:mm:ss")
                    };
                    //添加进本地历史记录
                    // gyim.addHisSingle(message.from, messageobj);

                    function judgeAndRender() {
                        var hasconvert = false;
                        // 当前会话列表中已经有消息来源的会话时，资源单、消息的同步
                        for (var i = 0; i < vueIM.chatContentList.length; i++) {
                            var thisid = vueIM.chatContentList[i].phone;
                            if (thisid == message.from) {
                                var msg = {
                                    usrUserId: '',
                                    sgId: '',
                                    chatType: vueIM.chatContentList[i].chatType,
                                    sendTime: new Date().getTime(),
                                    content: message.data,
                                    msgType: message.ext? message.ext.msgType: '',
                                    receiptType: message.ext? message.ext.receiptType : '',
                                    receiptId: message.ext? message.ext.receiptId : ''

                                };
                                vueIM.chatContentList[i].chatRecords.push(msg);
                                hasconvert = true;

                                if (message.data.indexOf("资源单(id:") != -1) {
                                    var chatstrid = message.data.split("资源单(id:")[1].split(")")[0];
                                    vueIM.chatContentList[i].latestLookOfferModel.offerId = chatstrid;
                                    vueIM.chatContentList[i].myoffer = true;
                                    if (touserobj.touser == message.from) {
                                        vueIM.offer_id = chatstrid;
                                        renderOffer();
                                        // vueIM.ismyoffer = true;
                                    }
                                };

                                if (touserobj.phone == message.from) { //当前聊天与接收信息是同一个人
                                    vueIM.pushSingleWord(vueIM.chatContentList[i]);
                                    $(".chat_win").scrollTop = $(".chat_win").scrollHeight;
                                } else if (touserobj.touser != message.from) { //当前聊天与接收信息非同一个人
                                    vueIM.chatContentList[i].red = true;
                                }
                                break;
                            }
                        }
                        // 当前会话列表中没有消息来源的会话时，同步获取公司信息，然后添加会话，添加消息，添加记录
                        if (hasconvert == false) {
                            $.ajax({
                                type: "post",
                                url: COMP_API,
                                data: JSON.stringify({
                                    mobile: message.from.split("-")[0],
                                    companyId:  message.from.split("-")[1],
                                    userType: URL_TOSER == '13800000000' ? 9 : 0
                                }),
                                xhrFields: {
                                    withCredentials: true
                                },
                                contentType: 'application/json',
                                async: false,
                                success: function (data) {
                                    var data_name = data.data.companyName + '-' + data.data.username;
                                    var data_head = data.data.profileImg;
                                    var data_myphone =  message.from;
                                    var sgId = data.data.id;
                                    var chatstrid;
                                    if (message.data.indexOf("资源单(id:") != -1) {
                                        chatstrid = message.data.split("资源单(id:")[1].split(")")[0];
                                    };
                                    var newconver = {
                                        "phone": data_myphone,
                                        "profile": data_head,
                                        "sgName": data_name,
                                        "red": true,
                                        "sgId": sgId,
                                        "latestLookOfferModel": {
                                            "sellerCompanyId": userInfo.companyId,
                                            "buyerCompanyId": data.data.companyId,
                                            "offerId": chatstrid
                                        },
                                        "last_orderid": 0,
                                        "myoffer": true,
                                        "chatType": 2,
                                        "chatRecords": [{
                                            usrUserId: data.data.id,
                                            sgId: userInfo.id,
                                            chatType: 2,
                                            sendTime: new Date().getTime(),
                                            content: message.data,
                                            msgType: message.ext ? message.ext.msgType : '',
                                            receiptType: message.ext ? message.ext.receiptType : '',
                                            receiptId: message.ext ? message.ext.receiptId : ''
                                        }]
                                    };
                                    if(message.ext && message.ext.userType == 9 &&  vueIM.addRobotTips) {
                                        var chatData = '您好，我是撮合机器人，负责为您推送您感兴趣商品的买卖盘资料，请勿回复'
                                        newconver.chatRecords.unshift({
                                            usrUserId: data.data.id,
                                            sgId: userInfo.id,
                                            chatType: 2,
                                            sendTime: new Date().getTime(),
                                            content: chatData
                                        })
                                        vueIM.addRobotTips = false;

                                    }
                                    vueIM.push_conver(newconver);
                                    vueIM.render_newConList(vueIM.chatContentList);
                                }
                            });
                        };
                    };
                    judgeAndRender()
                },
                onPictureMessage: function (message) {
                    console.log("收到来自" + message.from + "的图片消息：" + message.url);
                },
                onAudioMessage: function (message) {
                    console.log("收到来自" + message.from + "的音频消息：" + message.url);
                },
                onError: function (message) {
                    if (message.type == 8) {
                        var r = confirm("您的聊天已在其他地方打开,本窗口已失效，点击确定关闭")
                        if (r == true) {
                            window.close();
                        }
                    }
                }
            });
            document.getElementById("sent").addEventListener("click", function () {
                sent();
            });
            //  禁止回车换行
            document.getElementById("entry").onkeydown = function (e) {
                var code = e.charCode || e.keyCode;
                if (!e.ctrlkey && code === 13) {
                    event.cancelBubble = true;
                    event.preventDefault();
                    event.stopPropagation();
                }
            };
            // 回车发送消息，Ctrl + 回车换行
            document.getElementById("entry").onkeyup = function (e) {
                var code = e.charCode || e.keyCode;
                if (e.ctrlKey && code == 13) {
                    var newtext = this.value + '\n';
                    this.value = newtext;
                    this.innerHTML = newtext;
                } else if (!e.ctrlkey && code == 13) {
                    sent();
                }
            };
            // 发送消息，保存到本地然后顺手保存到服务器，其实应该先保存到服务器，成功了再保存到本地，不然消息不一致怎么办
            function sent(str) {
                var entryele = document.getElementById("entry");
                var myDate = new Date().Format("yyyy/MM/dd hh:mm:ss");
                var senttxt = str || entryele.value;
                if (senttxt.replace(/^\s+|\s+$/g, "") === '' || senttxt.replace(/^\s+|\s+$/g, "") === null) {
                    return;
                }
                var saveobj = {};
                // 1 群组 2 单聊
                let offerType = '', offerId = '';
                if(vueIM.history && vueIM.history.latestLookOfferModel){
                    offerType = vueIM.history.latestLookOfferModel.type;
                    offerId = vueIM.history.latestLookOfferModel.offerId;
                }
                if (vueIM.history) {
                    saveobj = {
                        usrUserId: userInfo.id,
                        usrCompanyId: userInfo.companyId,
                        sgId: vueIM.history.sgId,
                        chatType: vueIM.history.chatType,
                        fromMobile: LOGUSER + '-' + userInfo.companyId,
                        toCompanyId: vueIM.history.chatType == 1 ? '' : vueIM.history.partnerCompanyId,
                        toMobile: vueIM.history.chatType == 1 ? '' : vueIM.history.phone,
                        content: senttxt,
                        receiptType: vueIM.history.chatType == 2 && vueIM.offers.offerStatus !== 0 ? '' : offerType,
                        receiptId: vueIM.history.chatType == 2 && vueIM.offers.offerStatus !== 0 ? '' : offerId
                    };
                }
                if (str) {
                    saveobj = {
                        usrUserId: userInfo.id,
                        usrCompanyId: userInfo.companyId,
                        sgId: vueIM.history.sgId,
                        chatType: vueIM.history.chatType,
                        fromMobile: LOGUSER + '-' + userInfo.companyId,
                        toCompanyId: vueIM.history.chatType == 1 ? '' : vueIM.history.partnerCompanyId,
                        toMobile: vueIM.history.chatType == 1 ? '' : vueIM.history.phone,
                        content: str,
                        receiptType: vueIM.history.chatType == 2 && vueIM.offers.offerStatus !== 0 ? '' : offerType,
                        receiptId: vueIM.history.chatType == 2 && vueIM.offers.offerStatus !== 0 ? '' : offerId
                    };
                }

                $.ajax({
                    type: "POST",
                    url: SAVE_HIS,
                    async: true,
                    dataType: "json",
                    data: JSON.stringify(saveobj),
                    contentType: "application/json",
                    success: function (datas) {
                        console.log('datas', datas);
                    },
                    error: function (data) {}
                });
                if (str) {
                    return;
                }

                var messageobj = {
                    usrUserId: vueIM.history.usrUserId,
                    sgId: vueIM.history.sgId,
                    chatType: vueIM.history.chatType,
                    sendTime: new Date().getTime(),
                    content: senttxt,
                    time: new Date().Format("hh:mm")
                };
                document.getElementById("entry").value = ""; // 清空输入框
                // vueIM.pushSingleWord(saveobj);  // 添加当前会话的聊天记录
                vueIM.chatContentList[vueIM.currentActiveConver] && vueIM.chatContentList[vueIM.currentActiveConver]
                    .chatRecords.push(messageobj) && (vueIM.chatContentList[vueIM.currentActiveConver].latestChatTime =
                        new Date().getTime()); // 会话列表添加最后一条信息
                vueIM.pushSingleWord(vueIM.chatContentList[vueIM.currentActiveConver]); // 添加当前会话的聊天记录
                vueIM.setConListOrder();
            };

            // 资源单 ID 获取资源单信息，同步接口，为什么又是同步接口？
            function renderOffer(id) {
                var renderofferid = vueIM.offer_id;
                if(0 > renderofferid){ // 小于零表示：产品ID
                    return;
                }
                if (!renderofferid || renderofferid == null || history.chatType == 1) {
                    vueIM.offer_id = 0;
                    return;
                }
                // 获取资源单信息
                var api = vueIM.showMovement||(vueIM.history && vueIM.history.latestLookOfferModel && vueIM.history.latestLookOfferModel.type == 1) ?
                    OFFERS_API + renderofferid : MKORDER + userInfo.companyId + '/' + renderofferid;

                if (renderofferid) {
                    $.ajax({
                        type: "get",
                        url: api,
                        async: false,
                        dataType: "json",
                        success: function (datas) {
                            var res = datas.data;
                            if (datas.code == 0) {
                                if (!vueIM.showMovement&&vueIM.history.latestLookOfferModel && vueIM.history.latestLookOfferModel.type == 2) {
                                    vueIM.offers = res
                                } else {
                                    res.offerInfo.deliveryBeginDate = vueIM.format(res.offerInfo.deliveryBeginDate,'-');
                                    res.offerInfo.deliveryEndDate = vueIM.format(res.offerInfo.deliveryEndDate,'-');
                                    vueIM.offers = res.offerInfo;
                                }

                            } else {
                                vueIM.offer_id = 0;
                            }
                        }
                    });
                } else {
                    vueIM.offer_id = 0;
                }
            };
            var socket;

            function listenNewId() {
                var socket = io(SCOKET + 'userId=' + userInfo.id+ "&companyId=" + userInfo.companyId);
                console.log('userId=' + userInfo.id+ "&companyId=" + userInfo.companyId)
                socket.on('connect', function (e) {
                    console.log("打开scoket")
                });
                socket.on('order_status_notify', function (data) {
                    var dataobj = JSON.parse(data);
                    console.log(data)
                    vueIM.chatContentList.map(
                        function (currentValue, index, arr) {
                            if (currentValue.latestLookOfferModel.offerId == dataobj.offerId && !
                                currentValue.myoffer) {
                                currentValue.last_orderid = dataobj.orderId;
                                if (index == vueIM.currentActiveConver) {
                                    vueIM.order_id = dataobj.orderId
                                }
                            }
                        }
                    );
                });
            };
            if (USER_TYPE == 1) {
                listenNewId();
            };
            gyim.reg(LOGUSER + '-' + userInfo.companyId);
            init();

            function sendWord(obj,type, str) {
                var saveobj = {
                    usrUserId: userInfo.id,
                    usrCompanyId: userInfo.companyId,
                    sgId: obj.sgId,
                    chatType: obj.chatType,
                    fromMobile: LOGUSER + '-' + userInfo.companyId,
                    toCompanyId: obj.partnerCompanyId,
                    toMobile: obj.phone,
                    content: str,
                    receiptType: vueIM.history.chatType == 1 || type == 1 ? '' : receipt_type,
                    receiptId: vueIM.history.chatType == 1 || type == 1 ?  '' : receipt_id
                };

                $.ajax({
                    type: "POST",
                    url: SAVE_HIS,
                    async: true,
                    dataType: "json",
                    data: JSON.stringify(saveobj),
                    contentType: "application/json",
                    success: function (datas) {
                        // console.log('datas',datas);
                    },
                    error: function (data) {}
                });
            }

            function closeShadow(dom, type) {
                $(dom).css("display", "none");
                if (!type) {
                    vueIM.selectedList = [];
                    vueIM.searchUserList = [];
                    vueIM.searchWords = '';
                }
                vueIM.changeGroup = false;
            }

            function showShadow(dom) {
                $(dom).css("display", "block");
            }

            function showGroup() {
                vueIM.changeGroup = true;
                if (vueIM.history.chatType != 1) {
                    return;
                }
                // $(".showGroup").css("display","block");  // 显示组员
                showShadow('.group-bg');
                vueIM.history.groupMembers.forEach((item, index, arr) => {
                    arr[index]['name'] = arr[index].companyName;
                    arr[index].id = arr[index].usrCompanyId;
                })
                vueIM.selectedList.push(...vueIM.history.groupMembers);
            }

            function createGroupName() {
                // 判断是否是修改群组;
                if (vueIM.changeGroup) {
                    changeGroupMember();
                    return;
                }
                if (vueIM.selectedList.length == 0) {
                    vueIM.errorWord = '请选择用户'
                    return;
                }
                closeShadow(".group-bg", 1)
                showShadow('.group-name-bg')
            }

            function changeGroupMember() {
                 var groupMembers = [];
                for (var i = 0; i < vueIM.selectedList.length; i++) {
                    groupMembers.push({
                        "usrCompanyId": vueIM.selectedList[i].usrCompanyId, //组员公司id
                        "companyName": vueIM.selectedList[i].companyName, //组员公司名称
                        "usrUserId": vueIM.selectedList[i].usrUserId //组员用户id
                    })
                }
                closeShadow(".group-bg", 1)
                var groupData = {
                    usrUserId: userInfo.id,
                    usrCompanyId:userInfo.companyId,
                    groupMembers: groupMembers,
                    imGroupId: vueIM.history.sgId
                }
                $.ajax({
                    type: "PUT",
                    url: CHANGE_GROUP_MEMBER,
                    async: true,
                    dataType: "json",
                    contentType: 'application/json',
                    data: JSON.stringify(groupData),
                    success: function (datas) {
                        $.ajax({
                            type: "get",
                            // url: firstlist,
                            url: SEARCH_CHATLIST,
                            data: {
                                usrUserId: userInfo.id,
                                usrCompanyId: userInfo.companyId
                            },
                            async: false,
                            success: function (data) {
                                var conevrList = data.data;
                                vueIM.render_contact(conevrList);
                                vueIM.render(conevrList[0]);
                                vueIM.selectedList = [];
                                vueIM.searchUserList = [];
                                vueIM.searchWords = '';
                            }
                        });
                    }
                });
            }

            function createGroup() {
                if (!vueIM.groupName) {
                    // alert('请输入组名称')
                    vueIM.errorWord = '请输入组名称'
                    return;
                }
                var groupMembers = [];
                for (var i = 0; i < vueIM.selectedList.length; i++) {
                    groupMembers.push({
                        "usrCompanyId": vueIM.selectedList[i].usrCompanyId, //组员公司id
                        "companyName": vueIM.selectedList[i].companyName, //组员公司名称
                        "usrUserId": vueIM.selectedList[i].usrUserId //组员用户id
                    })
                }
                var groupData = {
                    usrUserId: userInfo.id,
                    usrCompanyId: userInfo.companyId,
                    groupName: vueIM.groupName,
                    groupMembers: groupMembers
                }
                $.ajax({
                    type: "POST",
                    url: CREATE_GRP,
                    async: true,
                    dataType: "json",
                    contentType: 'application/json',
                    data: JSON.stringify(groupData),
                    success: function (data) {
                        if(data.code!=0) {
                            vueIM.errorWord = data.message;
                            return;
                        }
                       closeShadow(".group-name-bg", 1)
                        $.ajax({
                            type: "get",
                            // url: firstlist,
                            url: SEARCH_CHATLIST,
                            data: {
                                usrUserId: userInfo.id,
                                usrCompanyId: userInfo.companyId
                            },
                            async: false,
                            success: function (data) {
                                var conevrList = data.data;
                                vueIM.render_contact(conevrList);
                                vueIM.render(conevrList[0]);
                                vueIM.selectedList = [];
                                vueIM.searchUserList = [];
                                vueIM.searchWords = '';
                                vueIM.groupName = '';
                            }
                        });
                    }
                });
            }

            function changeImg(dom, src) {
                $(dom).attr("src", src)
            }

            function goMkOrder() {
                window.open('/my.html#/marriedDeal/order/parse-create')
            }

            window.addEventListener("storage", function (e) {
                var isReload = localStorage.getItem("imNewOrder");
                if (isReload) {
                    localStorage.removeItem("imNewOrder");
                    window.location.reload()
                }

            })
        </script>
</body>

</html>
